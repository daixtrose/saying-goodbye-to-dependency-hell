<!DOCTYPE html>
<html>

<head>
  <title>Saying Goodbye to Dependency Hell with Git and Modern CMake ... and a Shell Script</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="./fonts.css" />
  <link rel="stylesheet" href="./open-sans.css" />
  <link rel="stylesheet" href="./talk.css" type="text/css">
</head>


<textarea id="source">

layout: true

<div class="footer"><div class="flexcontainer"><span>.body[[https://ducktrain.io](https://ducktrain.io)]</span>
<span>.center[emBo++ 2021]</span><span>.body[&copy; 2021 Markus Werle ([github](http://github.com/daixtrose) [linkedin](https://www.linkedin.com/in/markus-werle-04305a12a/))]</span></div></div>

---

class: middle
template: inverse
background-color: gray

.center[


# Saying Goodbye to Dependency Hell with Git and Modern CMake 

## ... And a Shell Script 
Duration: 1:05:42 (#NoEstimates)

![](images/embo-logo_03.png)

]


---

layout: false

# This talk and its accompanying code is Open Source&#8482;	

.split-50[
.column[
&nbsp;<br>
- You can download this talk **and** code samples at https://github.com/daixtrose/saying-goodbye-to-dep-hell
- The solution I present is available at https://github.com/daixtrose/cmake_utilities 
- Code published under MIT licence
    - The code for the talk framework is based on [remark.js](https://github.com/gnab/remark) and is stolen from [Kirk Shoop's Intro to RxCpp](https://github.com/kirkshoop/introductionToRxcpp) 
    - Please contribute fixes or [file an issue](https://github.com/daixtrose/saying-goodbye-to-dep-hell/issues) if you find errors or know about improvements. 
- Fotos published under [CC BY-SA](https://creativecommons.org/licenses/by-sa/4.0/legalcode) .image-fixed-40[![](images/CC_BY-SA_88x31.png)]   
]
.column[
![](images/qr-code-for-repo.svg)
]
]

---

background-image: url(images/DSC_0487_DxO.jpg)
background-size: cover


# .white[Disclaimer]

.split-48[
.column[
.white[
- This is only my solution **proposal**
  - It's not **The Perfect Solution**
  - There might be other solutions<br>I am not aware of yet
]
.fixed-pos-nearly-llc[Foto: Città .white[di Firenze, 2013]]
]
.column[
&nbsp;<br>
&nbsp;<br>
&nbsp;<br>
&nbsp;<br>
&nbsp;<br>
&nbsp;<br>
&nbsp;<br>
&nbsp;<br>
&nbsp;<br>
&nbsp;<br>
&nbsp;<br>
.white[
- Please give me some feedback
- Derive and make it even better  
]
]
]

---

layout: false

# Introducing Dependency Hell 

Imagine a RealWorld(TM) example like the following: You are maintaining two tools,

.split-40[
.column[
- `tool_1`
- `tool_2`

which depend on some libraries
- `lib_A`
- `lib_B`
- `lib_C`

Also there is an indirect dependency to 
- `libFreeAssange` (see next slides)

]
.column[
![](images/NamingThings.png)
]
]




---

layout: false

# Dependency Hell with Git Submodules - Tool 1 

Now let us set up the dependencies of [`https://github.com/dep-hell/tool_1`](https://github.com/dep-hell/tool_1) 

```bash
$ git clone https://github.com/dep-hell/tool_1
$ cd tool_1

# Assuming no dependencies have been configured by now
$ git `submodule add` -b master-yoda \ 
  https://github.com/dep-hell/lib_A 3rdParty/`lib_A`

$ git `submodule add` -b master-yoda \
  https://github.com/dep-hell/lib_B 3rdParty/`lib_B`
```

---

layout: false

# Dependency Hell with Git Submodules - Tool 1 

```bash
$ git status
On branch master-yoda
Your branch is up to date with 'origin/master-yoda'.

Changes to be committed:
  (use "git restore --staged <file>..." to unstage)
        `new file:   .gitmodules`
        `new file:   3rdParty/lib_A`
        `new file:   3rdParty/lib_B`
```

```bash
$ git commit -m "dependency setup"
$ git push # I commited to master-yoda here!
```



---

layout: false

# Dependency Hell with Git Submodules - Tool 1 

```bash
$ cat .gitmodules
[submodule "3rdParty/lib_A"]
        path = 3rdParty/lib_A
        url = https://github.com/dep-hell/lib_A
        branch = master-yoda
[submodule "3rdParty/lib_B"]
        path = 3rdParty/lib_B
        url = https://github.com/dep-hell/lib_B
        branch = master-yoda
```

---

layout: false

# Dependency Hell with Git Submodules - Tool 2 

Now let us set up the dependencies of [`https://github.com/dep-hell/tool_2`](https://github.com/dep-hell/tool_2) 

```bash
$ git clone https://github.com/dep-hell/tool_2
$ cd tool_2

# Assuming no dependencies have been configured by now
$ git submodule add -b master-yoda \ 
  https://github.com/dep-hell/lib_A 3rdParty/lib_A

$ git submodule add -b master-yoda \
  https://github.com/dep-hell/`lib_C` 3rdParty/`lib_C`
```

```bash
$ git commit -m "dependency setup"
$ git push # I commited to master-yoda here!
```
---

layout: false

# Dependency Hell with Git Submodules - Recursive Dependencies

> `lib_A` **and** `lib_B` **both** depend on `https://github.com/dep-hell/libFreeAssange`  
```
In order to understand recursion, you must first understand recursion.
```

```bash
git clone https://github.com/dep-hell/`lib_B`
cd lib_B
git submodule add `-b wikileaks` \ # Watch out for the devils here!
  https://github.com/dep-hell/libFreeAssange \
  3rdParty/libFreeAssange && cd ..
```

```bash
git clone https://github.com/dep-hell/`lib_C`
cd lib_C
git submodule add `-b belmarsh` \ # Watch out for the devils here!
  https://github.com/dep-hell/libFreeAssange \
  3rdParty/libFreeAssange
```

---

# Summary: This Is How Our Dependency Hell Looks Like

```bash
$ git clone https://github.com/Dep-Hell/tool_1
Cloning into 'tool_1'...
[...]
$ cd tool_1
$ `git submodule update --remote --init --recursive`
Submodule '3rdParty/lib_A' (https://github.com/dep-hell/lib_A) registered for path '3rdParty/lib_A'
Submodule '3rdParty/lib_B' (https://github.com/dep-hell/lib_B) registered for path '3rdParty/lib_B'
Cloning into '/emBOCode/tool_1/3rdParty/lib_A'...
Cloning into '/emBOCode/tool_1/3rdParty/lib_B'...
Submodule path '3rdParty/lib_A': checked out '`d8619eb51ace2661c4c2f6a19509dc94a66a726b`'
Submodule path '3rdParty/lib_B': checked out 'ca0c74edecc4bfe6cbe7496825ca448d200700f3'
Submodule '3rdParty/libFreeAssange' (https://github.com/dep-hell/libFreeAssange) registered for path '3rdParty/lib_B/3rdParty/libFreeAssange'
Cloning into '/emBOCode/tool_1/3rdParty/lib_B/3rdParty/libFreeAssange'...
Submodule path '3rdParty/lib_B/3rdParty/libFreeAssange': checked out '668ccf2050aade95cb847771670c229ed9e64efd'
```

???

- I hope you all remember well this command line, because all arguments are crucial for avoiding headaches
- Note that the submodules are not checked out with the dedicated branches, but use latest tag in this branch
- We come to this in a minute  

---

# Summary: This Is How Our Dependency Hell Looks Like

.split-50[
.column[
<pre>
    <span style="font-weight:bold;color:#3333FF;background-color: #ff0;">tool_1</span>
    ├── <span style="font-weight:bold;color:#3333FF;">3rdParty</span>
    │   ├── <span style="font-weight:bold;color:#3333FF;">lib_A</span>
    │   │   ├── LICENSE
    │   │   └── README.md
    │   └── <span style="font-weight:bold;color:#3333FF;background-color: #ff0;">lib_B</span>
    │       ├── <span style="font-weight:bold;color:#3333FF;">3rdParty</span>
    │       │   └── <span style="font-weight:bold;color:#3333FF;">libFreeAssange</span>
    │       │       ├── LICENSE
    │       │       └── README.md
    │       ├── LICENSE
    │       └── README.md
    ├── LICENSE
    └── README.md
</pre>
]
.column[
<pre>
    <span style="font-weight:bold;color:#3333FF;background-color: #ff0;">tool_2</span>
    ├── <span style="font-weight:bold;color:#3333FF;">3rdParty</span>
    │   ├── <span style="font-weight:bold;color:#3333FF;">lib_A</span>
    │   │   ├── LICENSE
    │   │   └── README.md
    │   └── <span style="font-weight:bold;color:#3333FF;background-color: #ff0;">lib_C</span>
    │       ├── <span style="font-weight:bold;color:#3333FF;">3rdParty</span>
    │       │   └── <span style="font-weight:bold;color:#3333FF;">libFreeAssange</span>
    │       │       ├── LICENSE
    │       │       └── README.md
    │       ├── LICENSE
    │       └── README.md
    ├── LICENSE
    └── README.md
</pre>

]
]

---

layout: false
background-image: url(images/DSC_0010_2_DxO.jpg)
background-size: cover

---

# Entering Hell

```bash
[.../tool_1] $ echo "some additional text" \
  >> 3rdParty/lib_B/3rdParty/libFreeAssange/README.md
[.../tool_1] $ git status

  On branch master-yoda
  Your branch is up to date with 'origin/master-yoda'.
  
  Changes not staged for commit:
    (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
    (use &quot;git restore &lt;file&gt;...&quot; to discard changes in working directory)
    (commit or discard the untracked or modified content in submodules)
          modified:   `3rdParty/lib_B (modified content)`
  
  no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)
```
---

# Entering Hell 

```bash
[.../tool_1] $ git add 3rdParty/lib_B/3rdParty/libFreeAssange/README.md
fatal: Pathspec '3rdParty/lib_B/3rdParty/libFreeAssange/README.md' 
is in submodule '3rdParty/lib_B'
```

> This is a reasonable check. Happy to have it. It may be counter-intuitive though.

---

# Entering Hell 

```bash
$ cd 3rdParty/lib_B/3rdParty/libFreeAssange
$ git add README.md 
$ git commit -m "some change"
$ git push
```

<pre>
fatal: You are <span style="font-weight:bold;color:#3333FF;background-color: #ff0;">not currently on a branch.</span>
To push the history leading to the current (detached HEAD)
state now, use

    git push origin HEAD:<name-of-remote-branch>
</pre>

> 

???

- git is complicated enough to drive away inexperienced people
- neither `git pull` will give you an indication whether we are up-to-date here

---

# Entering Hell 

Let me get this clear: we **declared** `libFreeAssange` to **be** on branch `wikileaks`

```bash
$ cat ../../../lib_B/.gitmodules 
[submodule "3rdParty/libFreeAssange"]
        path = 3rdParty/libFreeAssange
        url = https://github.com/dep-hell/libFreeAssange
        `branch = wikileaks`
```

but it's not, so here we go doing something manually (the release of Boeing 737 MAX can't wait): 

```bash
[.../libFreeAssange] $ git reset --soft HEAD~1
[.../libFreeAssange] $ git `checkout wikileaks` # <--- This!
[.../libFreeAssange] $ git add README.md
[.../libFreeAssange] $ git commit -m "some change"
[.../libFreeAssange] $ git push
```

---

# Being in Hell

```bash 
[.../libFreeAssange] $ cd ../..
[.../lib_B] $ git status
HEAD detached at ca0c74e
Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
        `modified:   3rdParty/libFreeAssange (new commits)`

no changes added to commit (use "git add" and/or "git commit -a")
```

> Practice **[Yoga with Adriene](https://www.youtube.com/user/yogawithadriene)**, 
because we need a deep breath here. Let's go:

---

```bash 
[.../`lib_B`] $ git add 3rdParty/libFreeAssange
[.../lib_B] $ git comm... # WAIT! OH NO!
[.../lib_B] $ git reset --soft HEAD~1
[.../lib_B] $ git checkout `master-yoda # shall we use this branch ...`
[.../lib_B] $ git pull
[.../lib_B] $ git add 3rdParty/libFreeAssange
[.../lib_B] $ git commit -m "update of libFreeAssange"
[.../lib_B] $ git push
[.../lib_B] $ cd ../..
[.../`tool_1`] $ git checkout -b \ # .. or `shall we use another branch?`
  `dummy-branch-for-a-change-that-changes-nothing` 
[.../tool_1] $ git push --set-upstream origin \
  dummy-branch-for-a-change-that-changes-nothing 
[.../tool_1] $ git add 3rdParty/lib_B 
[.../tool_1] $ git commit -m "update of lib_B, due to ..." 
[.../tool_1] $ git push 
```

> 10 commands to reflect a change in a library. Scales with O(n) with the # of nesting levels.  

---

layout: false
background-image: url(images/2019-03-15_IMG_4376.JPG)
background-size: cover


---


layout: false
background-image: url(images/DSC_0198_DxO.jpg)
background-size: cover

.split-50[
.column[
&nbsp;<br>
&nbsp;<br>
&nbsp;<br>
&nbsp;<br>
&nbsp;<br>
&nbsp;<br>
- Submodules are bound to commits<br>rather than branches.
- In a deeply nested structure<br>the updates bubble up the tree. 
- Changes are not local, but they should.
> Git add and commit for changes of the *database*, not changes of any files<br>under version control
- Does this encourage distribution of code into multiple repositories? 
]
.column[
]
]

???

- I don't know the reason for the design decision for having submodules stick to commits rather than branches
- We need a directory structure that allows code editing across multiple repositories, because a code change might affect several of them.
- Seen a trend that people put everything in one repo, since tools do not support modularity
- I think something is wrong with this.


---

background-image: url(images/DSC_0211_DxO.jpg)
background-size: cover


# .white[Let's talk]

# .white[&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; about CMake]
    
---

# CMake - Some Advice

> Never ever follow any advice that is older than 3 months. This advice won't age well.

- Don't try to use the internet to find out how CMake works 
- Maybe even don't try to find out how CMake works at all. 
  - See what happened to [Isabella Muerte](https://twitter.com/slurpsmadrips) 
  - Read her blog about *[Everything You Never Wanted to Know About CMake](https://izzys.casa/2019/02/everything-you-never-wanted-to-know-about-cmake/)*
- Read a ... book?
  - > Craig Scott: *Professional CMake: A Practical Guide*   
- I wish this book had been written 2 years earlier  
- Listen to Craig's talks on YouTube, e.g. https://www.youtube.com/watch?v=m0DwB4OvDXk  

---

# How to Deal with Dependencies in CMake 

```cmake
# See https://cmake.org/cmake/help/latest/module/FetchContent.html
include(`FetchContent`) 
```

- While `ExternalProject_Add()` executes **at build time**, `FetchContent` performs earlier **during the configuration step**.
- If you fetch dependencies that have `CMake` configured correctly, `add_subdirectory()` works fine.


---

# The 2-Step Approach of FetchContent

```cmake
FetchContent_`Declare`( # 1st step
  libFreeAssange
  GIT_REPOSITORY https://github.com/dep-hell/libFreeAssange
  GIT_TAG        belmarsh
)
```

```cmake
FetchContent_`MakeAvailable`(libFreeAssange) # 2nd step 
```

---

# The 2-Step Approach of FetchContent

```cmake
FetchContent_`MakeAvailable`(libFreeAssange) # 2nd step 
```

is equivalent to

```cmake
FetchContent_GetProperties(libFreeAssange)
if(NOT libFreeAssange_POPULATED)
  FetchContent_Populate(libFreeAssange)
  `add_subdirectory`(${libFreeAssange_SOURCE_DIR} 
                   ${libFreeAssange_BINARY_DIR})
endif()
```

---

# The 2-Step Approach of FetchContent

```cmake
FetchContent_`MakeAvailable`(libFreeAssange) # 2nd step 
```

is equivalent to

```cmake
FetchContent_GetProperties(libFreeAssange)
if(NOT libFreeAssange_POPULATED)
  FetchContent_Populate(libFreeAssange)
  add_subdirectory(${libFreeAssange_SOURCE_DIR} 
                   ${libFreeAssange_BINARY_DIR})
  # `Add your own stuff here if the library you include` 
  # `is not properly configured` 
endif()
```

---

# Key features of FetchContent

## Fetching content from Git repositories

```cmake
FetchContent_Declare(
    cmake_utilities
    GIT_REPOSITORY https://github.com/daixtrose/cmake_utilities
    GIT_TAG        main)
```

## Fetching content from URLs

```cmake
FetchContent_Declare(
    myCompanyIcons
    URL      https://intranet.mycompany.com/assets/iconset_1.12.tar.gz
    URL_HASH 5588a7b18261c20068beabfb4f530b87)
```

---

# Key features of FetchContent

## Fetching content from a **source directory** (!)  

```cmake
FetchContent_Declare(some_name SOURCE_DIR /path/to/directory)
```  

---

# Key features of FetchContent

- The first call to `FetchContent_Declare` wins. 
  > You can **overwrite settings** in libraries you include!
  > - change branch
  > - change source location
  > - etc.

---

# My Proposal in a Nutshell  

> Content of `dependencies.txt`

```bash
# Please add dependencies as 
# <LOWERCASE_NAME> <URL> <GIT TAG>  

# Internal dependencies
lib_A https://github.com/dep-heaven/lib_A master-yoda
lib_B https://github.com/dep-heaven/lib_B master-yoda
libFreeAssange https://github.com/dep-heaven/libFreeAssange belmarsh

# External dependencies
catch2 https://github.com/catchorg/Catch2 v2.x
fmt https://github.com/fmtlib/fmt master
```

---

# My Proposal in a Nutshell

> Content of `CMakeLists.txt`

```cmake
include(FetchContent)

FetchContent_Declare(
  cmake_utilities
  GIT_REPOSITORY https://github.com/daixtrose/cmake_utilities
  GIT_TAG        main
)
FetchContent_MakeAvailable(cmake_utilities)

fetchcontent_dependencies( # <-- THIS
    FILENAME dependencies.txt 
    WORKSPACE ws)
```

---

# The resulting directory structure

```
tool_1
  ├── include
  │   └── tool_1
  ├── src
  ├── test-catch
  └── ws `<-- This directory is in .gitignore !`
      ├── catch2
      ├── fmt
      ├── libFreeAssange
      ├── lib_A
      └── lib_B
```

---

# Calling `setup.sh` when changes are available

<pre>
[.../tool_1] $ ./setup.sh
<span style="color:blue;">Checking ws/lib_A</span>
<span style="color:blue;">Checking ws/lib_B</span>
<span style="color:blue;">Checking ws/libFreeAssange</span>
<span style="color:red;"> Your branch is behind 'origin/belmarsh' by 1 commit, and can be fast-forwarded. </span>
<span style="color:blue;">Checking ws/catch2</span>
<span style="color:blue;">Checking ws/fmt</span>
<span style="color:blue;">Checking /home/markus/PROJECT/dep-heaven/tool_1</span>

<span style="color:red;">!!!! ===&gt; There are uncommited changes &lt;=== !!!!</span>
On branch master-yoda
Your branch is up to date with 'origin/master-yoda'.

Changes not staged for commit:
  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
  (use &quot;git restore &lt;file&gt;...&quot; to discard changes in working directory)
        modified:   <span style="background-color:yellow;">dependencies.txt</span>

no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)
</pre>

---

# Calling `setup.sh` when changes are available

<pre>
  <span style="font-weight:bold;">diff --git a/dependencies.txt b/dependencies.txt</span>
  <span style="font-weight:bold;">index ef27091..4d3fab6 100644</span>
  <span style="font-weight:bold;">--- a/dependencies.txt</span>
  <span style="font-weight:bold;">+++ b/dependencies.txt</span>
  <span style="color:teal;">@@ -4,6 +4,7 @@</span>
   # Internal dependencies
   lib_A https://github.com/dep-heaven/lib_A master-yoda
   lib_B https://github.com/dep-heaven/lib_B master-yoda
  <span style="color:green;">+</span><span style="color:green;">libFreeAssange https://github.com/dep-heaven/libFreeAssange belmarsh</span>
   
   # External dependencies
   catch2 https://github.com/catchorg/Catch2 v2.x
</pre>

---

# Sidenote

If you rename all your `master` branches and run 

```bash
$ git config --global init.defaultBranch `master-yoda`,
```

then `slave`ry will vanish and no longer be on this planet.



</textarea>

<script src="remark-latest.min.js">
</script>
<script type="text/javascript">
  var hljs = remark.highlighter.engine;
</script>
<script src="terminal.language.js" type="text/javascript"></script>
<script>
  var slideshow = remark.create({
    ratio: "16:9",
    highlightLanguage: "cpp",
    highlightStyle: "tomorrow",
    highlightSpans: true,
  });

  // extract the embedded styling from ansi spans
  var highlighted = document.querySelectorAll("code.terminal span.hljs-ansi");
  Array.prototype.forEach.call(highlighted, function (next) {
    next.insertAdjacentHTML("beforebegin", next.textContent);
    next.parentNode.removeChild(next);
  });
</script>


</body>

</html>